name: Build and Deliver

on:
  push:
    branches:
      - "main"
      - "preview"
      - "feature/**"
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: "ghcr.io/${{ github.repository }}"

jobs:
  build:
    name: Build & Publishes Docker Image
    runs-on: ubuntu-latest
    
    permissions:
      packages: write
    
    steps:
      - uses: actions/checkout@v3
  
#       - name: Login to GitHub Container Registry
#         uses: docker/login-action@v2
#         with:
#           username: ${{ github.repository_owner }}
#           password: ${{ secrets.GITHUB_TOKEN }}
#           registry: ${{ env.REGISTRY }}
  
      - name: Build and push backend (prod)
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: "${{ env.IMAGE_NAME }}:latest"
          platforms: linux/amd64
          build-args: |
            configfile=_config-production.yml

      - name: Build and push backend (devl)
        if: github.ref == 'refs/heads/preview'
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: "${{ env.IMAGE_NAME }}:latest"
          platforms: linux/amd64
          build-args: |
            configfile=_config-dev.yml

      - name: Build and push backend (local)
        if: startsWith(github.ref, 'refs/heads/feature')
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: "${{ env.IMAGE_NAME }}:latest"
          platforms: linux/amd64

      - name: Extract build artifact from docker image
        uses: shrink/actions-docker-extract@v2
        id: extract
        with:
          image: "${{ env.IMAGE_NAME }}:latest"
          path: /usr/share/nginx/html/

      - run: |
          ls -l ${{ steps.extract.outputs.destination }}
          tar czvf dist.tar.gz -C ${{ steps.extract.outputs.destination }}/html .
          ls -l
          
      - name: Upload build artifact
        uses: actions/upload-artifact@v2
        with:
          path: ./dist.tar.gz
          name: dist

  release:
    needs: build
    uses: chnm/.github/.github/workflows/create-release.yml@feature/initial-reusable-workflows
    with:
      github-run-id: "${{ github.run_id }}"
      github-workflow: "${{ github.workflow }}"
      github-workflow-ref: "${{ github.workflow_ref }}"
      github-workflow-sha: "${{ github.workflow_sha }}"
      github-workspace: "${{ github.workspace }}"
      github-repository: "${{ github.repository }}"
      github-repository-owner: "${{ github.repository_owner }}"
      github-repository-name: "${{ github.event.repository.name }}"
      github-repository-url: "${{ github.repository-url }}"
      github-action-ref: "${{ github.action_ref }}"
      github-event-name: "${{ github.event_name }}"
      github-actor: "${{ github.actor }}"
      github-triggering-actor: "${{ github.triggering_actor }}"
      github-base-ref: "${{ github.base_ref }}"
      github-ref-name: "${{ github.ref_name }}"
      github-ref-type: "${{ github.ref_type }}"
      github-ref: "${{ github.ref }}"
      github-sha: "${{ github.sha }}"
      build-artifact-name: "dist"
      release-artifact-tarball-filename: "dist.tar.gz"
      release-tag-name-type: "iso"

  deploy:
    needs: release
    if: false
    runs-on: ubuntu-latest # self-hosted
    steps:
      - run: echo "TODO"







